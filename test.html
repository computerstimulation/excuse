<html>

<head>
    <link rel="stylesheet" href="styles.css">
    <!-- Pixel Code for https://overtracking.com/ -->
    <script defer src="https://overtracking.com/p/p4gAlTJv4a7BUyVy"></script>
    <!-- END Pixel Code -->
</head>

<body>
    <div id="headerDivId">
        <input type="text" placeholder="enter word to mute" id="muted-words-input">
        <input type="text" placeholder="enter word to unmute" id="unmuted-words-input">
    </div>
    <div class="article-list-div" id="articleListDivId"></div>

    <script>
        let _500NewestStoriesDataVariable
        let articlesOnDisplay = [];

        //let filteredWords
        let filteredWords = [];

        function adjustArticleListHeight() {
            document.getElementById('articleListDivId').style.maxHeight =
                window.innerHeight - document.getElementById('headerDivId').offsetHeight + 'px';
        }

        adjustArticleListHeight();
        window.addEventListener('resize', adjustArticleListHeight);

        //get the filtered words from local storage
        if (localStorage.getItem('filteredWords')) {
            filteredWords = JSON.parse(localStorage.getItem('filteredWords'));
            console.log('filtered words: ' + filteredWords);
        }

        //listen for muted words input enter key press and update the filtered words array
        document.getElementById('muted-words-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {

                //make sure the word is not already in the array and make sure the word is not empty
                if (!filteredWords.includes(this.value) && this.value !== '') {
                    filteredWords.push(this.value);
                    console.log('filtered words: ' + filteredWords);

                    //save the filtered words to local storage
                    localStorage.setItem('filteredWords', JSON.stringify(filteredWords));

                    //clear the input field
                    this.value = '';
                }
            }
        });

        //listen for unmuted words input enter key press and update the filtered words array
        document.getElementById('unmuted-words-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                //make sure the word is in the array
                if (filteredWords.includes(this.value)) {
                    filteredWords = filteredWords.filter(word => word !== this.value);
                    console.log('filtered words: ' + filteredWords);

                    //save the filtered words to local storage
                    localStorage.setItem('filteredWords', JSON.stringify(filteredWords));

                    //clear the input field
                    this.value = '';
                }
            }
        });


        function compareNumbers(a, b) {
            return a - b;
        }

        //on page load make an api call to get new stories from hacker news (sort by id from max to min)
        window.onload = function () {
            fetch(`https://hacker-news.firebaseio.com/v0/newstories.json?print=pretty`)
                .then(response => response.json())
                .then(data => {
                    _500NewestStoriesDataVariable = data;
                    console.log(_500NewestStoriesDataVariable);
                    _500NewestStoriesDataVariable.forEach(storyID => {
                        fetch(`https://hacker-news.firebaseio.com/v0/item/${storyID}.json?print`)
                            .then(response => response.json())
                            .then(data => {
                                let articleDate = new Date(data.time * 1000);
                                let articleURL = data.url;
                                let articleId = data.id;
                                let articleText = data.text || "";
                                let articleKids = data.kids;

                                // Check if the article title or text contains any of the filtered words
                                const containsFilteredWord = filteredWords.some(word => {
                                    const regex = new RegExp(`\\b${word.toLowerCase()}\\b`, 'i');
                                    return (data.title && regex.test(data.title.toLowerCase())) || regex.test(articleText.toLowerCase());
                                });

                                // If the article contains a filtered word, do not display it
                                if (containsFilteredWord) return;

                                getKidsInformation(articleKids, articleId);
                                articlesOnDisplay.push(articleId);
                                let reversedArticlesOnDisplay = articlesOnDisplay.sort(compareNumbers);
                                let articleIdIndex = reversedArticlesOnDisplay.indexOf(articleId);
                                let nextArticleId = reversedArticlesOnDisplay[articleIdIndex + 1] || 0;

                                if (document.querySelector(`[data-article-id='${nextArticleId}']`)) {
                                    document.querySelector(`[data-article-id='${nextArticleId}']`).insertAdjacentHTML('afterend', `
                <a data-article-id="${articleId}" href="${articleURL}">
                    ${data.title}<br>
                        <div class="time-div">${articleDate}</div>
                        <div class="article-text-div">${articleText}</div>
                    
                </a>
            `);
                                } else {
                                    document.querySelector('.article-list-div').insertAdjacentHTML('beforeend', `
                <a data-article-id="${articleId}" href="${articleURL}">
                    ${data.title}<br>
                        <div class="time-div">${articleDate}</div>
                        <div class="article-text-div">${articleText}</div>
                    
                </a>
            `);
                                }
                            });

                    });
                })
        };

        //if article has kids then fetch the kids and display their text under the story text
        async function getKidsInformation(articleKids, articleId) {
            if (articleKids) {
                articleKids.forEach(kid => {
                    fetch(`https://hacker-news.firebaseio.com/v0/item/${kid}.json?print`)
                        .then(response => response.json())
                        .then(data => {
                            let commentText = data.text;
                            let commentDate = new Date(data.time * 1000);
                            let commentId = data.id;
                            let commentDeleted = data.deleted;
                            let commentDead = data.dead;
                            //console.log('article kid text: ' + data.text);

                            //if the comment has not been deleted, then display it
                            if (!commentDeleted && !commentDead) {
                                document.querySelector(`[data-article-id='${articleId}']`).insertAdjacentHTML('beforeend',
                                    `<div class="comment-container-div"><br><div class="comment-div" data-comment-id="${commentId}">${commentText}</div><br></div>`);
                            };
                        })
                })
            }
        }

        //recursive call to get more article comments

        //add event listener to document
        document.addEventListener('keydown', function (event) {

            //if enter key is pressed
            if (event.key === 'Enter') {

                //if event target is muted word input
                if (event.target.id === 'muted-words-input') {
                    //make sure the word is not already in the array and make sure the word is not empty
                    if (!filteredWords.includes(this.value) && this.value !== '') {
                        filteredWords.push(this.value);
                        console.log('filtered words: ' + filteredWords);

                        //save the filtered words to local storage
                        localStorage.setItem('filteredWords', JSON.stringify(filteredWords));

                        //clear the input field
                        this.value = '';

                        //focus out of the input field
                        this.blur();
                    }
                }

                //if event target is unmuted word input
                if (event.target.id === 'unmuted-words-input') {
                    //make sure the word is in the array
                    if (filteredWords.includes(this.value)) {
                        filteredWords = filteredWords.filter(word => word !== this.value);
                        console.log('filtered words: ' + filteredWords);

                        //save the filtered words to local storage
                        localStorage.setItem('filteredWords', JSON.stringify(filteredWords));

                        //clear the input field
                        this.value = '';

                        //focus out of the input field
                        this.blur();
                    };
                };
            };
        });

        //add function to clear filtered words
        document.addEventListener('click', function (event) {
            if (event.target.id === 'clearFilteredWordsButtonId') {
                console.log(`clearing filtered words: ${filteredWords}`);
                filteredWords = [];
                localStorage.setItem('filteredWords', JSON.stringify(filteredWords));
            };
        });
    </script>
</body>

</html>